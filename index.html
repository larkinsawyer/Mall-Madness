<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mall Madness — Retro Computer (PWA)</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#f7f3e9" />
  <style>
    /* --- Visual style inspired by 1989 Mall Madness plastic computer --- */
    :root{
      --case-bg: #f7f3e9; /* beige plastic */
      --panel-bg: #f0d9c7; /* slightly darker face */
      --btn-shadow: rgba(0,0,0,0.25);
      --accent: #2b2b2b;
      --led-off: #3a3a3a;
      --led-on: #59d65a;
      --font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --button-radius: 8px;
      --big-btn-size: 84px;
    }
    html,body{height:100%;margin:0;background:#e7e3db;font-family:var(--font-family);-webkit-font-smoothing:antialiased}
    .wrap{
      max-width:980px;margin:18px auto;padding:18px;
      display:grid;grid-template-columns: 420px 1fr;gap:16px;
    }

    /* Left: retro computer panel */
    .computer {
      background: linear-gradient(180deg, var(--case-bg) 0%, #efe6d6 100%);
      border-radius:20px;padding:22px;box-shadow:0 8px 18px rgba(0,0,0,0.18);
      border: 3px solid rgba(0,0,0,0.06);
    }
    .screen {
      height:130px;border-radius:6px;background:#0b1220;color:#dff6d8;padding:10px;
      font-family: "Courier New", monospace; font-size:14px; overflow:auto;
      box-shadow: inset 0 -6px 24px rgba(0,0,0,0.6);
      display:flex;align-items:flex-start;justify-content:flex-start;flex-direction:column;
    }
    .screen .line { margin:2px 0; }

    .controls{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn {
      background:linear-gradient(180deg,#fff 0%, #e7e3db 100%);
      border:1px solid rgba(0,0,0,0.12);padding:8px 12px;border-radius:8px;
      box-shadow: 0 6px 0 rgba(0,0,0,0.12), inset 0 -2px 0 rgba(0,0,0,0.03);
      cursor:pointer;font-weight:700;
    }
    .btn:active{transform:translateY(2px);box-shadow:none}
    .big-btn{
      width:var(--big-btn-size);height:var(--big-btn-size);
      font-size:16px;border-radius:14px;display:flex;align-items:center;justify-content:center;
    }

    .btn-move { background: linear-gradient(180deg,#ffd3d3,#ff9d9d); }
    .btn-repeat { background:linear-gradient(180deg,#fff7c7,#ffef9a); }
    .btn-game { background:linear-gradient(180deg,#d3f0ff,#9bd2ff); }

    .slots { margin-top:12px; display:flex;gap:12px; align-items:center; }
    .slot { width:120px;height:48px;border-radius:8px;background:#222;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow: inset 0 -4px 8px rgba(0,0,0,0.35); }
    .slot.small{width:80px;height:36px}

    .led-row{display:flex;gap:6px;margin-left:auto}
    .led { width:14px;height:14px;border-radius:4px;background:var(--led-off);box-shadow:0 2px 0 rgba(0,0,0,0.14) inset; }
    .led.on{background:var(--led-on);box-shadow:0 2px 6px rgba(80,220,120,0.4); }

    /* Right: game helper */
    .panel { background:var(--panel-bg);border-radius:12px;padding:14px;box-shadow:0 6px 12px rgba(0,0,0,0.08) }
    .color-picker{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .color-swatch{width:46px;height:46px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;cursor:pointer}
    .color-red{background:#e64545} .color-blue{background:#4a9be8} .color-green{background:#45c47a} .color-yellow{background:#ffd34a;color:#333}
    .small-info{font-size:13px;color:#333;margin-top:8px}
    .log{height:320px;overflow:auto;background:#fff;padding:8px;border-radius:8px;margin-top:10px;font-family:monospace;font-size:13px}
    .row { display:flex;gap:8px;align-items:center;margin:6px 0; }

    footer{grid-column:1/-1;margin-top:10px;color:#666;font-size:13px}
    @media (max-width:900px){
      .wrap{grid-template-columns:1fr; padding:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="computer" role="application" aria-label="Mall Madness Retro Computer">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="font-weight:800;font-size:20px;color:var(--accent)">VOICE OF THE MALL</div>
        <div class="led-row" aria-hidden="true">
          <div id="led-power" class="led"></div>
          <div id="led-game" class="led"></div>
          <div id="led-move" class="led"></div>
        </div>
      </div>

      <div class="screen" id="screen" aria-live="polite" role="status">
        <div class="line">Press <strong>GAME ON</strong> to begin.</div>
      </div>

      <div class="controls">
        <button id="gameBtn" class="btn btn-game big-btn" title="Game On">GAME ON</button>
        <button id="moveBtn" class="btn btn-move big-btn" title="Move / Confirm">MOVE</button>
        <button id="repeatBtn" class="btn btn-repeat big-btn" title="Repeat">REPEAT</button>
        <div class="slots" style="margin-left:auto">
          <div class="slot small" id="buySlot">BUY</div>
          <div class="slot small" id="bankSlot">BANK</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
        <div class="slot" id="cardSlot" style="width:200px">Card Slot: <span id="cardHolder" style="margin-left:8px;font-weight:normal">—</span></div>
        <div style="margin-left:auto;font-size:13px;color:#333">Players: <span id="playersCount">0</span></div>
      </div>
    </div>

    <div class="panel" aria-hidden="false">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Player Setup / Debug</strong>
        <button id="resetBtn" class="btn">Reset</button>
      </div>

      <div class="row" style="margin-top:8px;">
        <div style="width:42%"><label>Active Players</label>
          <div class="color-picker" id="playerPicker">
            <div class="color-swatch color-red" data-color="red" style="opacity:0.45">RED</div>
            <div class="color-swatch color-blue" data-color="blue" style="opacity:0.45">BLUE</div>
            <div class="color-swatch color-green" data-color="green" style="opacity:0.45">GREEN</div>
            <div class="color-swatch color-yellow" data-color="yellow" style="opacity:0.45">YEL</div>
          </div>
        </div>

        <div style="width:56%">
          <label>Insert Card / Action</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="cardSelect" class="btn" aria-label="Select card player">
              <option value="">-- choose player card --</option>
              <option value="red">Red</option>
              <option value="blue">Blue</option>
              <option value="green">Green</option>
              <option value="yellow">Yellow</option>
            </select>
            <button id="insertBuy" class="btn">Insert Buy</button>
            <button id="insertBank" class="btn">Insert Bank</button>
          </div>
        </div>
      </div>

      <div class="small-info">Game log & announcements</div>
      <div id="log" class="log" role="log" aria-live="polite"></div>
    </div>

    <footer>
      This is a fan recreation for personal use. Drop your audio files into <code>/audio/</code> and keep the AUDIO_MAP in the script. To make this installable as a PWA, open the site over HTTPS or run locally via a simple static server.
    </footer>
  </div>

  <script>
  /***************************************************************
   * Mall Madness - Retro Computer (client logic) - integrated with user clips
   ***************************************************************/

  const AUDIO_MAP = {
    // Startup / game on sequence
    "startup": "audio/001_game_on_hi_colors.mp3",
    "try_again": "audio/003_try_again_later.mp3",

    // Phrase / word clips
    "attention": "audio/002_attention_mall_shoppers.mp3",
    "meet_all_bank": "audio/008-meet_all_at_bank.mp3",
    "pizza": "audio/0202_hungry_meet_friend_pizza_shop.mp3",
    "restroom": "audio/0203_go_to_restroom.mp3",
    "lights_parking": "audio/0204_left_lights_on_parking_lot.mp3",
    "and_at_the": "audio/004_and_at_the.mp3",
    "clearance_word": "audio/007_clearance_at_the.mp3",
    "sale_word": "audio/006_sale_at_the.mp3",
    "beep": "audio/005_beep.mp3",

    // Movement numbers (4–12)
    "move_4":  "audio/1003_move_4_spaces.mp3",
    "move_5":  "audio/1005_move_5_spaces.mp3",
    "move_6":  "audio/1006_move_6_spaces.mp3",
    "move_7":  "audio/1007_move_7_spaces.mp3",
    "move_8":  "audio/1008_move_8_spaces.mp3",
    "move_9":  "audio/1009_move_9_spaces.mp3",
    "move_10": "audio/1010_move_10_spaces.mp3",
    "move_11": "audio/1011_move_11_spaces.mp3",
    "move_12": "audio/1012_move_12_spaces.mp3",

    // Sale / clearance / buy outcomes
    "ching": "audio/0301_ching_ching_cash_register.mp3",
    "special_sale": "audio/0302_hey_you_get_a_special_sale.mp3",
    "special_clearance": "audio/0303_hey_you_get_a_special_clearance.mp3",
    "long_line": "audio/0304_long_line_try_again_later.mp3",
    "out_of_stock": "audio/0305_sorry_out_of_stock_try_again_later.mp3",
    "costs_5_more": "audio/0306_your_item_costs_5_more.mp3",

    // Bank responses
    "bank_50":  "audio/0401_take_50_from_bank.mp3",
    "bank_75":  "audio/0402_take_75_from_bank.mp3",
    "bank_100": "audio/0403_take_100_from_bank.mp3",
    "bank_closed": "audio/0404_bank_closed.mp3",

    // Fallback / turn indicators
    "turn_red": "audio/005_beep.mp3",
    "turn_blue": "audio/005_beep.mp3",
    "turn_green": "audio/005_beep.mp3",
    "turn_yellow": "audio/005_beep.mp3",

    // sales announcement
    "announce_sales": "audio/006_sale_at_the.mp3",

    // Store clips
    "store_card_shop": "audio/_0101_card_shop.mp3",
    "store_book_store": "audio/_0102_book_store.mp3",
    "store_camera_store": "audio/_0103_camera_store.mp3",
    "store_computer_store": "audio/_0104_computer_store.mp3",
    "store_department_store": "audio/_0105_department_store.mp3",
    "store_drug_store": "audio/_0106_drug_store.mp3",
    "store_electronics_store": "audio/_0107_electronics_store.mp3",
    "store_fashion_boutique": "audio/_0108_fashion_boutique.mp3",
    "store_jewelry_store": "audio/_0109_jewelry_store.mp3",
    "store_kitchen_store": "audio/_0110_kitchen_store.mp3",
    "store_mens_shop": "audio/_0111_mens_shop.mp3",
    "store_pet_shop": "audio/_0112_pet_shop.mp3",
    "store_phone_store": "audio/_0113_phone_store.mp3",
    "store_record_store": "audio/_0114_record_store.mp3",
    "store_shoe_store": "audio/_0115_shoe_store.mp3",
    "store_sports_shop": "audio/_0116_sports_shop.mp3",
    "store_sunglasses_boutique": "audio/_0117_sunglasses_boutique.mp3",
    "store_toy_store": "audio/_0118_toy_store.mp3"
  };

  // Preload audio objects
  const audio = {};
  Object.entries(AUDIO_MAP).forEach(([key, filename])=>{
    const a = new Audio(filename);
    a.preload = "auto";
    audio[key] = a;
  });

  // UI refs
  const screen = document.getElementById('screen');
  const logEl = document.getElementById('log');
  const gameBtn = document.getElementById('gameBtn');
  const moveBtn = document.getElementById('moveBtn');
  const repeatBtn = document.getElementById('repeatBtn');
  const buySlot = document.getElementById('buySlot');
  const bankSlot = document.getElementById('bankSlot');
  const cardSelect = document.getElementById('cardSelect');
  const insertBuy = document.getElementById('insertBuy');
  const insertBank = document.getElementById('insertBank');
  const playerPicker = document.getElementById('playerPicker');
  const playersCountEl = document.getElementById('playersCount');
  const cardHolder = document.getElementById('cardHolder');
  const resetBtn = document.getElementById('resetBtn');
  const ledPower = document.getElementById('led-power');
  const ledGame = document.getElementById('led-game');
  const ledMove = document.getElementById('led-move');

  // App state
  const state = {
    players: { red:false, blue:false, green:false, yellow:false },
    playerOrder: [],
    currentTurnIndex: 0,
    awaitingColorSelection: false,
    lastAnnouncement: null,
    cardInsertedFor: null
  };

  // Helpers
  function log(msg){
    const d = new Date().toLocaleTimeString();
    const line = document.createElement('div');
    line.textContent = `[${d}] ${msg}`;
    logEl.prepend(line);
  }
  function screenWrite(text){
    const line = document.createElement('div');
    line.className='line';
    line.innerHTML = text;
    screen.prepend(line);
    if(screen.children.length > 8) screen.removeChild(screen.lastChild);
  }
  function play(key){
    const a = audio[key];
    if(!a){
      log(`Audio missing for "${key}"`);
      screenWrite(`<em>(sound:${key})</em> ${key}`);
      state.lastAnnouncement = key;
      return;
    }
    try {
      a.currentTime = 0;
      a.play().catch(err=> {
        console.warn("Play interrupted:", err);
      });
      state.lastAnnouncement = key;
      log(`Playing: ${key} -> ${AUDIO_MAP[key] || 'unknown'}`);
    } catch(e){
      console.warn("Play failed",e);
    }
  }

  // convenience: choose random element
  function rnd(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function capitalize(s){return s && s[0].toUpperCase()+s.slice(1);}

  // UI actions
  // Select players by clicking swatches
  playerPicker.addEventListener('click', (ev)=>{
    const sw = ev.target.closest('.color-swatch');
    if(!sw) return;
    const color = sw.dataset.color;
    state.players[color] = !state.players[color];
    sw.style.opacity = state.players[color] ? '1' : '0.45';
    updatePlayersCount();
  });

  function updatePlayersCount(){
    const count = Object.values(state.players).filter(Boolean).length;
    playersCountEl.textContent = count;
  }

  // GAME ON sequence
gameBtn.addEventListener('click', ()=>{
  const active = Object.keys(state.players).filter(k => state.players[k]);
  if(active.length === 0){
    screenWrite("Select at least one player color on the right, then press GAME ON.");
    return;
  }

  state.gameStarted = true;
  state.playerOrder = active.slice();
  state.currentTurnIndex = 0;
  state.awaitingColorSelection = false;

  ledPower.classList.add('on');
  ledGame.classList.add('on');
  ledMove.classList.remove('on');

  screenWrite("<strong>GAME ON</strong> - Initializing...");
  play('startup');

  setTimeout(()=>{
    play('attention');
    screenWrite("Attention Mall Shoppers!");
  }, 1400);

  setTimeout(()=>{
    play('announce_sales');
    screenWrite("Sales & clearances announced. Use MOVE for each player's turn.");
  }, 3000);
});


    // End registration phase after colors announced
    setTimeout(()=>{
      state.awaitingColorSelection = false;
      // If user didn't register any order, build default order from selected players
      const active = Object.keys(state.players).filter(k=>state.players[k]);
      if(active.length > 0){
        state.playerOrder = active.slice(); // keep UI-chosen order
      } else {
        // default to all colors
        state.playerOrder = ['red','blue','green','yellow'];
      }
      screenWrite("Registration complete. Player order: " + state.playerOrder.map(capitalize).join(', '));
      log("Player order: " + state.playerOrder.join(','));
      // announce first turn
      setTimeout(()=> announceNextTurn(), 900);
    }, 3500 + 4*900 + 800);
  });

  // MOVE button: registration during initial sequence, or play a turn (move) during play
  moveBtn.addEventListener('click', ()=>{
  // Must have started a game
  if(!state.gameStarted){
    screenWrite("Press GAME ON to start a game first.");
    return;
  }

  // Which shopper is taking a turn? Use the selected card color.
  const currentColor = cardSelect.value;
  if(!currentColor || !state.players[currentColor]){
    screenWrite("Choose a player card color on the right, then press MOVE.");
    return;
  }

  // Start the turn
  screenWrite(`${capitalize(currentColor)}... it's your turn.`);
  play(`turn_${currentColor}`);
  ledMove.classList.add('on');

  // Choose a movement (4..12) and play the corresponding movement clip
  const moveKeys = ['move_4','move_5','move_6','move_7','move_8','move_9','move_10','move_11','move_12'];
  const chosenMoveKey = rnd(moveKeys);

  setTimeout(()=>{
    play(chosenMoveKey);
    const numeric = chosenMoveKey.split('_')[1]; // "4","5",...
    screenWrite(`${capitalize(currentColor)}...Move ${numeric}.`);
    log(`${capitalize(currentColor)} moves (${numeric}).`);

    // Random special instructions (pizza / restroom / lights)
    const r = Math.random();
    if(r < 0.12){
      play('pizza'); screenWrite(`${capitalize(currentColor)}... meet a friend at the pizza shop.`);
    } else if(r < 0.22){
      play('restroom'); screenWrite(`${capitalize(currentColor)}... go to the restroom.`);
    } else if(r < 0.28){
      play('lights_parking'); screenWrite(`${capitalize(currentColor)}... left your lights on in the parking lot.`);
    }

    ledMove.classList.remove('on');
    // No auto-advance of player here – you change player by changing the card selection.
  }, 900);
});


  // REPEAT button: repeat last announcement
  repeatBtn.addEventListener('click', ()=>{
    const key = state.lastAnnouncement;
    if(!key){
      screenWrite("Nothing to repeat.");
      return;
    }
    play(key);
    screenWrite(`Repeating: ${key}`);
  });

  // Card selection / insertion
  cardSelect.addEventListener('change', (ev)=> {
    const val = ev.target.value;
    cardHolder.textContent = val ? capitalize(val) : '—';
    state.cardInsertedFor = val || null;
  });

  // List of store keys for random store selection in buy flow
  const STORE_KEYS = [
    "store_card_shop","store_book_store","store_camera_store","store_computer_store",
    "store_department_store","store_drug_store","store_electronics_store","store_fashion_boutique",
    "store_jewelry_store","store_kitchen_store","store_mens_shop","store_pet_shop",
    "store_phone_store","store_record_store","store_shoe_store","store_sports_shop",
    "store_sunglasses_boutique","store_toy_store"
  ];

  // BUY insertion flow: plays store clip then outcome clip
  insertBuy.addEventListener('click', ()=>{
    if(!state.cardInsertedFor){
      screenWrite("Insert a player card first (select a color).");
      return;
    }
    const player = state.cardInsertedFor;
    screenWrite(`${capitalize(player)} inserts card into BUY slot.`);
    // Choose a random store to 'enter'
    const storeKey = rnd(STORE_KEYS);
    setTimeout(()=>{
      // Play the store clip (if present)
      play(storeKey);
      screenWrite(`${capitalize(player)} enters store (${storeKey.replace('store_','').replace(/_/g,' ')}).`);
    }, 300);

    // After store clip, play buy outcome
    setTimeout(()=>{
      // Weighted random for realistic outcomes
      const r = Math.random();
      if(r < 0.08){ play('long_line'); screenWrite("Long line — Try again later!"); }
      else if(r < 0.14){ play('out_of_stock'); screenWrite("Sorry - out of stock, try again later."); }
      else if(r < 0.25){ play('special_clearance'); screenWrite("Hey! You get a special clearance!"); }
      else if(r < 0.40){ play('special_sale'); screenWrite("Hey! You get a special sale!"); }
      else if(r < 0.60){ play('costs_5_more'); screenWrite("Your item costs $5 more."); }
      else { play('ching'); screenWrite("Ching Ching! Purchase successful."); }
    }, 1600);
  });

  // BANK insertion flow: plays bank outcomes (50/75/100 or closed)
  insertBank.addEventListener('click', ()=>{
    if(!state.cardInsertedFor){
      screenWrite("Insert a player card first (select a color).");
      return;
    }
    const player = state.cardInsertedFor;
    screenWrite(`${capitalize(player)} inserts card into BANK slot.`);
    setTimeout(()=>{
      const r = Math.random();
      if(r < 0.12){
        play('bank_closed'); screenWrite("Bank closed.");
      } else {
        // give money (weighted)
        const choice = Math.random();
        if(choice < 0.5){ play('bank_50'); screenWrite("Take $50 from bank."); }
        else if(choice < 0.85){ play('bank_75'); screenWrite("Take $75 from bank."); }
        else { play('bank_100'); screenWrite("Take $100 from bank."); }
      }
    }, 700);
  });

  // Reset
  resetBtn.addEventListener('click', ()=>{
    Object.keys(state.players).forEach(k=>state.players[k]=false);
    document.querySelectorAll('.color-swatch').forEach(sw=>sw.style.opacity='0.45');
    state.playerOrder = [];
    state.currentTurnIndex = 0;
    state.lastAnnouncement = null;
    state.cardInsertedFor = null;
    cardSelect.value = '';
    cardHolder.textContent = '—';
    log("Reset game state.");
    screenWrite("Game reset. Press GAME ON to start again.");
    ledPower.classList.remove('on'); ledGame.classList.remove('on'); ledMove.classList.remove('on');
  });

  // announce next turn helper
  function announceNextTurn(){
    if(state.playerOrder.length === 0){
      state.playerOrder = Object.keys(state.players).filter(k=>state.players[k]);
      if(state.playerOrder.length === 0) state.playerOrder = ['red','blue','green','yellow'];
    }
    const next = state.playerOrder[state.currentTurnIndex] || state.playerOrder[0];
    play(`turn_${next}`);
    screenWrite(`${capitalize(next)}...Your turn.`);
  }

  // beforeinstallprompt note
  window.addEventListener('beforeinstallprompt', (e)=> {
    e.preventDefault();
    screenWrite("PWA install ready. Use browser menu to install.");
    window.deferredPrompt = e;
  });

  // register service worker
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(()=> {
      log("Service Worker registered.");
    }).catch(err=> {
      log("SW registration failed: " + err);
    });
  }

  </script>
</body>
</html>
