<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mall Madness Computer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA: theme color + manifest -->
  <meta name="theme-color" content="#ff3c7f" />
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- iOS specific meta -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Mall Madness" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root {
      --purple-body: #602a7a;
      --purple-dark: #3b174b;
      --turquoise: #31c3c8;
      --hot-pink: #ff4fa3;
      --neon-yellow: #ffe66b;
      --orange: #ff9f43;
      --screen-bg: #111319;
      --screen-glow: #59ffb5;
      --text-light: #fefafc;
      --text-muted: #c7c1d8;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #3f1457 0, #05020b 55%);
      color: var(--text-light);
      min-height: 100vh;
      margin: 0;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .console {
      width: 100%;
      max-width: 420px;
      background: linear-gradient(145deg, var(--purple-body), var(--purple-dark));
      border-radius: 36px;
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.75),
        0 0 0 4px rgba(255, 255, 255, 0.07);
      padding: 16px 16px 20px;
      position: relative;
      overflow: hidden;
    }

    .console::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at top left,
          rgba(255, 255, 255, 0.12),
          transparent 55%);
      pointer-events: none;
    }

    .console-header {
      text-align: center;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .console-title {
      font-size: 1.2rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--neon-yellow);
      text-shadow:
        0 0 6px rgba(0, 0, 0, 0.9),
        0 0 10px rgba(255, 239, 122, 0.4);
    }

    .console-subtitle {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .color-strip {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin: 10px 4px 12px;
      position: relative;
      z-index: 1;
    }

    .color-chip {
      border-radius: 999px;
      padding: 4px 0;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      text-align: center;
      border: 1px solid rgba(0, 0, 0, 0.4);
      box-shadow: 0 2px 0 rgba(0, 0, 0, 0.6);
      cursor: pointer;
      opacity: 0.65;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.15s;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.25), transparent);
    }

    .color-chip.active {
      opacity: 1;
      transform: translateY(-1px);
      box-shadow:
        0 3px 0 rgba(0, 0, 0, 0.75),
        0 0 0 2px rgba(255, 255, 255, 0.18);
    }

    .chip-red {
      background: linear-gradient(145deg, #ff6b6b, #c92a2a);
      color: #fff;
    }
    .chip-blue {
      background: linear-gradient(145deg, #4dabf7, #1864ab);
      color: #fff;
    }
    .chip-green {
      background: linear-gradient(145deg, #51cf66, #2b8a3e);
      color: #fff;
    }
    .chip-yellow {
      background: linear-gradient(145deg, #ffe066, #f08c00);
      color: #3b2800;
    }

    .screen-wrap {
      position: relative;
      z-index: 1;
      border-radius: 18px;
      padding: 6px;
      background: radial-gradient(circle at top, #4a3e84, #130b2a);
      box-shadow:
        0 0 0 2px rgba(0, 0, 0, 0.6),
        inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      margin-bottom: 12px;
    }

    .screen-inner {
      border-radius: 14px;
      background: radial-gradient(circle at top left,
          rgba(89, 255, 181, 0.12),
          var(--screen-bg) 55%);
      min-height: 96px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow:
        inset 0 0 0 1px rgba(255, 255, 255, 0.04),
        0 0 12px rgba(89, 255, 181, 0.2);
      position: relative;
    }

    .screen-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--screen-glow);
      opacity: 0.88;
      margin-bottom: 4px;
    }

    #screen {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      color: #e5fff4;
      min-height: 40px;
      line-height: 1.3;
    }

    #status {
      margin-top: 6px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .led-row {
      position: absolute;
      right: 10px;
      top: 8px;
      display: flex;
      gap: 4px;
    }

    .led {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(120, 120, 120, 0.5);
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.8);
    }
    .led.on {
      background: var(--screen-glow);
      box-shadow:
        0 0 4px rgba(89, 255, 181, 0.9),
        0 0 8px rgba(89, 255, 181, 0.6);
    }

    .button-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 10px 6px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      cursor: pointer;
      box-shadow:
        0 3px 0 rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(0, 0, 0, 0.6);
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.1s;
      color: #fff;
      text-align: center;
      white-space: nowrap;
    }

    button:active {
      transform: translateY(2px);
      box-shadow:
        0 1px 0 rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(0, 0, 0, 0.8);
      filter: brightness(0.96);
    }

    .btn-game-on {
      grid-column: span 3;
      background: radial-gradient(circle at top, #ffd1f0, var(--hot-pink));
    }

    .btn-move {
      background: radial-gradient(circle at top, #c7fff9, var(--turquoise));
      color: #073a3b;
    }

    .btn-repeat {
      background: radial-gradient(circle at top, #fff7c7, var(--neon-yellow));
      color: #3b2f00;
    }

    .btn-buy {
      background: radial-gradient(circle at top, #ffd3b6, var(--orange));
    }

    .btn-bank {
      background: radial-gradient(circle at top, #d2ccff, #5248ff);
    }

    .btn-long-game {
      grid-column: span 3;
      background: radial-gradient(circle at top, #f2f2f2, #9e9e9e);
      color: #1a1a1a;
      font-size: 0.65rem;
    }

    .foot-panel {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
      z-index: 1;
    }

    .foot-title {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }

    .player-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.7rem;
      padding: 3px 0;
    }
    .player-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }
    .dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.8);
    }
    .dot.red { background: #ff6b6b; }
    .dot.blue { background: #4dabf7; }
    .dot.green { background: #51cf66; }
    .dot.yellow { background: #ffe066; }

    .player-meta {
      text-align: right;
      color: var(--text-muted);
    }

    .player-meta span {
      margin-left: 8px;
    }

    .purchase-row {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    select {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.7);
      background: rgba(10, 7, 25, 0.9);
      color: var(--text-light);
      outline: none;
    }

    @media (max-width: 380px) {
      .button-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .btn-game-on,
      .btn-long-game {
        grid-column: span 2;
      }
    }
  </style>
</head>
<body>
  <div class="console">
    <div class="console-header">
      <div class="console-title">Mall Madness</div>
      <div class="console-subtitle">Electronic Shopping Computer</div>
    </div>

    <!-- Color selection (who's playing) -->
    <div class="color-strip" id="color-strip">
      <div class="color-chip chip-red" data-color="Red">Red</div>
      <div class="color-chip chip-blue" data-color="Blue">Blue</div>
      <div class="color-chip chip-green" data-color="Green">Green</div>
      <div class="color-chip chip-yellow" data-color="Yellow">Yellow</div>
    </div>

    <!-- Screen -->
    <div class="screen-wrap">
      <div class="screen-inner">
        <div class="led-row">
          <div class="led" id="led-power"></div>
          <div class="led" id="led-turn"></div>
        </div>
        <div class="screen-label">Voice of the Mall</div>
        <div id="screen">Select which shopper colors are playing, then press GAME ON.</div>
        <div id="status"></div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="button-grid">
      <button class="btn-game-on" id="btn-game-on">Game On</button>

      <button class="btn-move" id="btn-move">Move</button>
      <button class="btn-repeat" id="btn-repeat">Repeat</button>

      <button class="btn-buy" id="btn-buy">Buy</button>
      <button class="btn-bank" id="btn-bank">Bank</button>

      <button class="btn-long-game" id="btn-long-game" type="button">
        Toggle: 6&thinsp;/&thinsp;10 Item Game
      </button>
    </div>

    <div class="purchase-row">
      <span>Purchase type:</span>
      <select id="purchase-type">
        <option value="item">Store item (peg)</option>
        <option value="pizza">Pizza ($5 helper)</option>
      </select>
      <span style="flex:1; text-align:right;">
        Use BUY only when you are in a store.
      </span>
    </div>

    <!-- Player info -->
    <div class="foot-panel" id="players-panel">
      <div class="foot-title">Shopper Status</div>
      <!-- Player rows inserted by JS -->
    </div>
  </div>

  <script>
    /***********************
     * AUDIO CLIP MAPPING
     * (updated from Audio Files.csv)
     ***********************/
    const clips = {
      GAME_ON: "001_game_on_hi_colors.mp3",
      TRY_AGAIN_LATER: "003_try_again_later.mp3",
      
      // phrase / word clips
      ATTENTION_SHOPPERS: "002_attention_mall_shoppers.mp3",
      MEET_ALL_BANK: "008_meet_all_at_bank.mp3",
      YOU_HUNGRY_PIZZA: "0202_hungry_meet_friend_pizza_shop.mp3",
      RESTROOM: "0203_go_to_restroom.mp3",
      LIGHTS_PARKING_LOT: "0204_left_lights_on_parking_lot.mp3",
      AND_AT_THE: "004_and_at_the.mp3",
      CLEARANCE: "007_clearance_at_the.mp3",
      SALE: "006_sale_at_the.mp3",
      BEEP: "005_beep.mp3",
      
      // movement numbers (4–12)
      GO_4: "1003_move_4_spaces.mp3",
      GO_5: "1005_move_5_spaces.mp3",
      GO_6: "1006_move_6_spaces.mp3",
      GO_7: "1007_move_7_spaces.mp3",
      GO_8: "1008_move_8_spaces.mp3",
      GO_9: "1009_move_9_spaces.mp3",
      GO_10: "1010_move_10_spaces.mp3",
      GO_11: "1011_move_11_spaces.mp3",
      GO_12: "1012_move_12_spaces.mp3",
      
      // sale/clearance/bank
      CHING_CHING: "0301_ching_ching_cash_register.mp3",
      SPECIAL_SALE: "0302_hey_you_get_a_special_sale.mp3",
      SPECIAL_CLEARANCE: "0303_hey_you_get_a_special_clearance.mp3",
      LONG_LINE: "0304_long_line_try_again_later.mp3",
      OUT_OF_STOCK: "0305_sorry_out_of_stock_try_again_later.mp3",
      COSTS_5_MORE: "0306_your_item_costs_5_more.mp3",
      BANK_50: "0401_take_50_from_bank.mp3",
      BANK_75: "0402_take_75_from_bank.mp3",
      BANK_100: "0403_take_100_from_bank.mp3",
      BANK_CLOSED: "0404_bank_closed.mp3",


      // store name announcements
      CARD_SHOP: "0101_card_shop.mp3",
      BOOK_STORE: "0102_book_store.mp3",
      CAMERA_STORE: "0103_camera_store.mp3",
      COMPUTER_STORE: "0104_computer_store.mp3",
      DEPARTMENT_STORE: "0105_department_store.mp3",
      DRUG_STORE: "0106_drug_store.mp3",
      ELECTRONICS_STORE: "0107_electronics_store.mp3",
      FASHION_BOUTIQUE: "0108_fashion_boutique.mp3",
      JEWELRY_STORE: "0109_jewelry_store.mp3",
      KITCHEN_STORE: "0110_kitchen_store.mp3",
      MENS_SHOP: "0111_mens_shop.mp3",
      PET_SHOP: "0112_pet_shop.mp3",
      PHONE_STORE: "0113_phone_store.mp3",
      RECORD_STORE: "0114_record_store.mp3",
      SHOE_STORE: "0115_shoe_store.mp3",
      SPORTS_SHOP: "0116_sports_shop.mp3",
      SUNGLASSES_BOUTIQUE: "0117_sunglasses_boutique.mp3",
      TOY_STORE: "0118_toy_store.mp3"
    };

    let lastAudio = null;
    let lastClipKey = null;

    function playClip(key, labelText) {
      const src = clips[key];
      if (!src) {
        if (labelText) {
          updateScreen(labelText + " (no audio mapped: " + key + ")");
        } else {
          updateScreen("Missing audio: " + key);
        }
        return;
      }
      if (lastAudio) {
        lastAudio.pause();
      }
      const audio = new Audio(src);
      lastAudio = audio;
      lastClipKey = key;
      audio.play().catch(err => {
        console.error("Audio play error", err);
      });
      if (labelText) {
        updateScreen(labelText);
      }
    }

async function playClipSequence(keys, screenText) {
  // Optional: update screen once at the start
  if (screenText) updateScreen(screenText);

  for (const key of keys) {
    const src = clips[key];
    if (!src) continue;

    await new Promise(resolve => {
      const audio = new Audio(src);
      lastAudio = audio;
      lastClipKey = key;

      audio.addEventListener("ended", resolve);
      audio.addEventListener("error", resolve);

      audio.play().catch(() => resolve());
    });
  }
}

    /***********************
     * GAME STATE
     ***********************/
    const COLORS = ["Red", "Blue", "Green", "Yellow"];
    let activePlayers = [];
    let players = {}; // e.g. { Red: { items: 0, canBank: true } }
    let currentPlayerIndex = 0;
    let awaitingMovement = false; // true = MOVE will give directions; false = MOVE will end turn
    let lastMessage = "Select which shopper colors are playing, then press GAME ON.";
    let targetItems = 6; // 6 or 10
    let gameStarted = false;

    const STATE = {
      IDLE: "IDLE",
      RUNNING: "RUNNING"
    };
    let state = STATE.IDLE;

    /***********************
     * DOM HELPERS
     ***********************/
    const screenEl = document.getElementById("screen");
    const statusEl = document.getElementById("status");
    const ledPower = document.getElementById("led-power");
    const ledTurn = document.getElementById("led-turn");
    const playersPanel = document.getElementById("players-panel");
    const purchaseTypeSelect = document.getElementById("purchase-type");

    function updateScreen(text) {
      screenEl.textContent = text;
      lastMessage = text;
    }

    function setStatus(text) {
      statusEl.textContent = text || "";
    }

    function setPowerLed(on) {
      ledPower.classList.toggle("on", on);
    }

    function setTurnLed(on) {
      ledTurn.classList.toggle("on", on);
    }

    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function getCurrentPlayerColor() {
      if (!activePlayers.length) return null;
      return activePlayers[currentPlayerIndex % activePlayers.length];
    }

    function rebuildPlayerPanel() {
      // Clear old rows except title
      const rows = Array.from(playersPanel.querySelectorAll(".player-row"));
      rows.forEach(r => r.remove());

      activePlayers.forEach(color => {
        const p = players[color];
        const row = document.createElement("div");
        row.className = "player-row";

        const label = document.createElement("div");
        label.className = "player-label";

        const dot = document.createElement("span");
        dot.className = "dot " + color.toLowerCase();

        const name = document.createElement("span");
        name.textContent = color;

        label.appendChild(dot);
        label.appendChild(name);

        const meta = document.createElement("div");
        meta.className = "player-meta";
        meta.innerHTML =
          `<span>${p.items} item${p.items === 1 ? "" : "s"}</span>` +
          `<span>${p.canBank ? "Bank OK" : "Bank closed"}</span>`;

        row.appendChild(label);
        row.appendChild(meta);
        playersPanel.appendChild(row);
      });
    }

    function initPlayers() {
      players = {};
      activePlayers.forEach(color => {
        players[color] = {
          items: 0,           // counts pegs (not pizza)
          canBank: true,      // can withdraw? becomes false until they buy something
          hasJustBought: false // for internal bookkeeping if you want to extend
        };
      });
      rebuildPlayerPanel();
    }

    /***********************
     * COLOR SELECTION (who is playing)
     ***********************/
    document.querySelectorAll(".color-chip").forEach(chip => {
      chip.addEventListener("click", () => {
        const color = chip.dataset.color;
        if (state !== STATE.IDLE && gameStarted) {
          // do not allow changing colors mid-game
          return;
        }
        const idx = activePlayers.indexOf(color);
        if (idx === -1) {
          activePlayers.push(color);
          chip.classList.add("active");
        } else {
          activePlayers.splice(idx, 1);
          chip.classList.remove("active");
        }
        setStatus(
          activePlayers.length
            ? "Shoppers: " + activePlayers.join(", ")
            : "No shoppers selected yet."
        );
      });
    });

    /***********************
     * GAME FLOW
     ***********************/
    function startGameOn() {
      if (!activePlayers.length) {
        updateScreen("Choose at least one shopper color before pressing GAME ON.");
        return;
      }
      state = STATE.RUNNING;
      gameStarted = true;
      setPowerLed(true);
      initPlayers();
      currentPlayerIndex = 0;
      awaitingMovement = true;

      // Greeting: “Hi Red! Hi Blue! Hi Green! Hi Yellow!” in order of active players.
      const greetingOrder = ["Red", "Blue", "Green", "Yellow"].filter(c =>
        activePlayers.includes(c)
      );
      const greetText = greetingOrder.length
        ? "Hi " + greetingOrder.join("! Hi ") + "!"
        : "Hi Shoppers!";
      updateScreen(greetText + " Place your shoppers in the parking lots. Then wait for your turn.");
      playClip("GAME_ON", greetText);

      // First sales/clearance announcement (you can map these to real store clips)
      announceSalesAndClearance();

      const first = getCurrentPlayerColor();
      if (first) {
        setStatus(
          first +
            "'s turn. On your turn: Press MOVE, follow the Voice, move your piece, then BUY/BANK if you can, then press MOVE again to end your turn."
        );
      }
      setTurnLed(true);
    }

    function announceSalesAndClearance() {
      // Placeholder store names; you can wire real store-specific audio clips here.
      const stores = [
        "Short Circuit",
        "Book Store",
        "Camera Store",
        "Card Shop",
        "Computer Store",
        "Department Store",
        "Drug Store",
        "Electronics",
        "Fashion Boutique",
        "Jewelry Store",
        "Kitchen Store",
        "Men's Shop",
        "Pet Shop",
        "Phone Store",
        "Record Store",
        "Shoe Store",
        "Sports Shop",
        "Sunglasses Boutique",
        "Toy Store"
      ];
      const shuffled = shuffle(stores);
      const clearanceStore = shuffled[0];
      const sale1 = shuffled[1];
      const sale2 = shuffled[2];

      const msg =
  "Attention mall shoppers! Clearance at " +
  clearanceStore +
  ". Sales at " +
  sale1 +
  " and " +
  sale2 +
  ". Move the signs.";

updateScreen(msg);

// Play the full phrase as separate audio clips:
// 1) "Attention mall shoppers!"
// 2) "Clearance at the"
// 3) "Sale at the"
// 4) "and at the"
const sequence = [
  "ATTENTION_SHOPPERS", // "Attention mall shoppers!"
  "CLEARANCE",     // "Clearance at the"
  "SALE",          // "Sale at the"
  "AND_AT_THE"     // "and at the"
];

playClipSequence(sequence, msg);
    }

    function issueMovementForCurrentPlayer() {
      const color = getCurrentPlayerColor();
      if (!color) return;

      // Decide between numeric movement vs. special location
      const r = Math.random();
      if (r < 0.55) {
        // Move N spaces (still using GO_1..GO_12; you now have real audio for GO_4–GO_12)
        const spaces = Math.floor(Math.random() * 12) + 1; // 4–12
        const clipKey = "GO_" + spaces;
        const msg =
          color +
          "... move " +
          spaces +
          " space" +
          (spaces === 1 ? "" : "s") +
          ". Remember: move along spaces, no diagonals, and enter stores through doors only.";
        playClip(clipKey, msg);
        setStatus(
          "Try to move into a store to buy, or into the bank for cash. You don't have to use the full count when entering a store or bank."
        );
      } else {
        // Special movement events from the directions
        triggerSpecialEvent(color);
      }
      awaitingMovement = false; // now we're in the “take actions” phase
    }

    function triggerSpecialEvent(color) {
      const events = [
        "MEET_BANK",
        "HUNGRY_PIZZA",
        "RESTROOM",
        "LIGHTS_PARKING",
        "MOVE_AND_SEND_FRIEND_ARCADE",
        "MOVE_AND_SEND_FRIEND_ICECREAM",
        "MOVE_AND_SEND_FRIEND_ANYWHERE"
      ];
      const eventKey = events[Math.floor(Math.random() * events.length)];
      let msg = "";

      switch (eventKey) {
        case "MEET_BANK":
          msg =
            color +
            "... Meet all shoppers at the bank. Everyone move to the bank space. Take turns inserting credit cards and follow the BANK button instructions.";
          playClip("MEET_ALL_BANK", msg);
          setStatus(
            "Starting with " +
              color +
              ", each shopper uses BANK. The banker gives out $50, $75, or $100 as announced."
          );
          // For fairness, after this, everyone may bank again, even if they already went.
          activePlayers.forEach(c => {
            players[c].canBank = true;
          });
          rebuildPlayerPanel();
          break;

        case "HUNGRY_PIZZA":
          msg =
            color +
            "... You're hungry. Meet a friend at the Pizza Shop. Move your shopper and any one opponent to the Pizza Shop.";
          playClip("YOU_HUNGRY_PIZZA", msg);
          setStatus(
            "You can BUY pizza (choose Pizza) to unlock the bank again later. You don't get a peg for pizza."
          );
          break;

        case "RESTROOM":
          msg = color + "... Go to the restroom.";
          playClip("RESTROOM", msg);
          setStatus("Move your shopper to the restroom, then press MOVE to end your turn.");
          break;

        case "LIGHTS_PARKING":
          msg = color + "... You left your lights on. Go to the parking lot.";
          playClip("LIGHTS_PARKING_LOT", msg);
          setStatus("Move back to your entrance parking lot, then press MOVE to end your turn.");
          break;

        case "MOVE_AND_SEND_FRIEND_ARCADE": {
          const spaces = Math.floor(Math.random() * 12) + 1;
          msg =
            color +
            "... Move " +
            spaces +
            " spaces and send a friend to the Arcade.";
          updateScreen(msg);
          // You can optionally map a specific clip here
          setStatus(
            "After moving, choose an opponent and move their shopper to the Arcade. They cannot buy or bank on your turn."
          );
          break;
        }

        case "MOVE_AND_SEND_FRIEND_ICECREAM": {
          const spaces2 = Math.floor(Math.random() * 12) + 1;
          msg =
            color +
            "... Move " +
            spaces2 +
            " spaces and send a friend for Ice Cream.";
          updateScreen(msg);
          setStatus(
            "After moving, choose an opponent and move their shopper to the Ice Cream shop. They cannot buy or bank on your turn."
          );
          break;
        }

        case "MOVE_AND_SEND_FRIEND_ANYWHERE": {
          const spaces3 = Math.floor(Math.random() * 12) + 1;
          msg =
            color +
            "... Move " +
            spaces3 +
            " spaces and send a friend anywhere.";
          updateScreen(msg);
          setStatus(
            "After moving, choose an opponent and move their shopper to any space (store or bank). They still cannot buy or bank on your turn."
          );
          break;
        }
      }
    }

    function endTurnAndAdvance() {
      const color = getCurrentPlayerColor();
      if (!color) return;

      // Check win condition: 6 (or 10) items and at parking lot (physically)
      const p = players[color];
      if (p.items >= targetItems) {
        updateScreen(
          color +
            ", if your shopper is back at your own parking lot, you win the game!"
        );
        setStatus("Be the first to buy " + targetItems + " different items and return to your parking lot.");
        // You can stop further turns if you want by setting state = STATE.IDLE
      } else {
        // Next player
        currentPlayerIndex = (currentPlayerIndex + 1) % activePlayers.length;
        const nextColor = getCurrentPlayerColor();
        setStatus(
          nextColor +
            "'s turn. Press MOVE to start, follow the announcement, then MOVE again to end your turn."
        );
        updateScreen(nextColor + ", press MOVE to start your turn.");
      }
      awaitingMovement = true;
    }

    /***********************
     * BUY & BANK LOGIC
     ***********************/
    function handleBuy() {
      if (state !== STATE.RUNNING) {
        updateScreen("Press GAME ON to start a game first.");
        return;
      }
      const color = getCurrentPlayerColor();
      if (!color) return;
      const p = players[color];
      const purchaseType = purchaseTypeSelect.value; // "item" or "pizza"

      // Random outcome pieces
      const baseRoll = Math.random();
      const extraFiveRoll = Math.random();

      let msg = "";

      if (purchaseType === "pizza") {
        // Pizza is special: never discounted, sometimes costs $5 more, no peg.
        if (baseRoll < 0.25) {
          // can't buy pizza this time
          msg =
            color +
            "... Long line at the Pizza Shop. Try again later! Move out and back in on a future turn to try again.";
          playClip("LONG_LINE", msg);
        } else {
          // successful pizza
          let extra = "";
          if (extraFiveRoll < 0.25) {
            extra =
              " Today your pizza costs $5 more than usual. Pay $10 instead of $5.";
            playClip("COSTS_5_MORE", color + "... your pizza costs $5 more.");
          } else {
            extra = " Pay $5 for pizza.";
          }

          msg =
            color +
            "... Ching ching! You bought pizza. " +
            extra +
            " You do not get a peg, but now you may go back to the bank on a later turn.";
          playClip("CHING_CHING", msg);
          p.canBank = true; // pizza “unlocks” the bank
          p.hasJustBought = true;
        }
        rebuildPlayerPanel();
        return;
      }

      // Regular store item (with peg)
      if (baseRoll < 0.15) {
        // Out of stock / long line
        const choice = Math.random() < 0.5 ? "LONG_LINE" : "OUT_OF_STOCK";
        const clipKey = choice === "LONG_LINE" ? "LONG_LINE" : "OUT_OF_STOCK";
        msg =
          color +
          "... " +
          (choice === "LONG_LINE"
            ? "Long line, try again later!"
            : "I'm sorry, we're out of stock. Try again later!");
        playClip(clipKey, msg);
        setStatus(
          "On your next turn, if you are still in this store, you may move out and right back in to try again."
        );
        // Does NOT count as purchase; bank rules unaffected
      } else if (baseRoll < 0.6) {
        // Standard “Ching ching” buy
        msg =
          color +
          "... Ching ching! Check your shopping list card for the item price. Pay regular price unless there's a sale or clearance sign in this store.";
        playClip("CHING_CHING", msg);
        handleSuccessfulItemPurchase(p, /*specialType=*/ null, extraFiveRoll, color);
      } else if (baseRoll < 0.8) {
        // Special sale
        msg =
          color +
          "... Hey! You get a special sale! Pay the special sale price shown on your card.";
        playClip("SPECIAL_SALE", msg);
        handleSuccessfulItemPurchase(p, "sale", extraFiveRoll, color);
      } else {
        // Special clearance
        msg =
          color +
          "... Hey! You get a special clearance! Pay the special clearance price shown on your card.";
        playClip("SPECIAL_CLEARANCE", msg);
        handleSuccessfulItemPurchase(p, "clearance", extraFiveRoll, color);
      }

      rebuildPlayerPanel();
    }

    function handleSuccessfulItemPurchase(player, specialType, extraFiveRoll, color) {
      // Increase peg count
      player.items += 1;
      player.canBank = true; // after buying, they may bank again
      player.hasJustBought = true;

      if (extraFiveRoll < 0.2) {
        // “Your item costs $5 more!”
        const msg2 =
          color +
          "... Your item costs $5 more. Whatever you would have paid, add $5 to the total.";
        playClip("COSTS_5_MORE", msg2);
        setStatus(
          "The Voice always has the final word. Consult your shopping list and adjust the price by +$5."
        );
      } else {
        if (specialType === "sale") {
          setStatus(
            "Pay the special sale price on your list. If there was a clearance sign, you still pay the sale price because the Voice said 'special sale'."
          );
        } else if (specialType === "clearance") {
          setStatus(
            "Pay the special clearance price on your list. If there was a sale sign, you pay the lower clearance price."
          );
        } else {
          setStatus(
            "Pay regular / sale / clearance price based on the signs in the store, as shown on your shopping list card."
          );
        }
      }
    }

    function handleBank() {
      if (state !== STATE.RUNNING) {
        updateScreen("Press GAME ON to start a game first.");
        return;
      }
      const color = getCurrentPlayerColor();
      if (!color) return;
      const p = players[color];

      if (!p.canBank) {
        // “Bank closed” rule: you must buy something (or pizza) before next withdrawal.
        const msg =
          color +
          "... Bank closed. You must buy something before you can withdraw cash again.";
        playClip("BANK_CLOSED", msg);
        setStatus(
          "Remember: once you get money from the bank, you can't go back until you buy an item or pizza."
        );
        return;
      }

      // If allowed, choose how much the bank gives
      const roll = Math.random();
      let amount = 50;
      let clipKey = "BANK_50";

      if (roll < 0.33) {
        amount = 50;
        clipKey = "BANK_50";
      } else if (roll < 0.66) {
        amount = 75;
        clipKey = "BANK_75";
      } else {
        amount = 100;
        clipKey = "BANK_100";
      }

      const msg =
        color +
        "... Take $" +
        amount +
        " from the bank. The banker should count out the money to you.";
      playClip(clipKey, msg);
      setStatus(
        "After withdrawing, you must buy something before the bank will serve you again."
      );

      // After a successful withdrawal, lock banking until they buy again
      p.canBank = false;
      p.hasJustBought = false;
      rebuildPlayerPanel();
    }

    /***********************
     * BUTTON HANDLERS
     ***********************/
    document.getElementById("btn-game-on").addEventListener("click", () => {
      startGameOn();
    });

    document.getElementById("btn-move").addEventListener("click", () => {
      if (state !== STATE.RUNNING) {
        updateScreen("Press GAME ON to start a new game.");
        return;
      }

      const color = getCurrentPlayerColor();
      if (!color) {
        updateScreen("No shoppers selected. Choose colors and press GAME ON.");
        return;
      }

      if (awaitingMovement) {
        // Start of turn
        updateScreen(color + ", it's your turn. Listen carefully!");
        issueMovementForCurrentPlayer();
      } else {
        // End of turn
        endTurnAndAdvance();
      }
    });

    document.getElementById("btn-repeat").addEventListener("click", () => {
      if (lastClipKey) {
        playClip(lastClipKey, "Repeating: " + lastMessage);
      } else {
        updateScreen("Nothing to repeat yet.");
      }
    });

    document.getElementById("btn-buy").addEventListener("click", () => {
      handleBuy();
    });

    document.getElementById("btn-bank").addEventListener("click", () => {
      handleBank();
    });

    document.getElementById("btn-long-game").addEventListener("click", () => {
      targetItems = targetItems === 6 ? 10 : 6;
      updateScreen(
        "Shop till you drop! You must now buy " +
          targetItems +
          " different items and return to your parking lot to win."
      );
      setStatus(
        targetItems === 6
          ? "Standard game: first to 6 items + parking lot wins."
          : "Long game: first to 10 items + parking lot wins."
      );
    });

    // PWA: register service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("sw.js")
          .catch(err => console.error("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>
